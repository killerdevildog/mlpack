# CMakeLists.txt for Issue #3964 Reproduction Test
# Exact build configuration from the original issue

cmake_minimum_required(VERSION 3.16.0)
set(CMAKE_CXX_STANDARD 17)

project(issue_3964_test CXX)

# Add the reproduction test executable
add_executable(issue_3964_test "issue_3964_reproduction_test.cpp")

# Find mlpack (use system installation or build from source)
find_package(PkgConfig REQUIRED)
pkg_check_modules(MLPACK REQUIRED mlpack)

if(MLPACK_FOUND)
    target_include_directories(issue_3964_test PRIVATE ${MLPACK_INCLUDE_DIRS})
    target_link_libraries(issue_3964_test PRIVATE ${MLPACK_LIBRARIES})
    target_compile_options(issue_3964_test PRIVATE ${MLPACK_CFLAGS_OTHER})
endif()

# Find and link Armadillo
find_package(PkgConfig REQUIRED)
pkg_check_modules(ARMADILLO REQUIRED armadillo)

if(ARMADILLO_FOUND)
    target_include_directories(issue_3964_test PRIVATE ${ARMADILLO_INCLUDE_DIRS})
    target_link_libraries(issue_3964_test PRIVATE ${ARMADILLO_LIBRARIES})
endif()

# Find and link OpenMP (CRITICAL for reproducing the issue)
find_package(OpenMP REQUIRED)
if(OpenMP_CXX_FOUND)
    target_link_libraries(issue_3964_test PRIVATE OpenMP::OpenMP_CXX)
    message(STATUS "OpenMP found and linked - required for issue reproduction")
else()
    message(FATAL_ERROR "OpenMP not found - cannot reproduce issue #3964")
endif()

# Compilation flags matching the original issue
target_compile_options(issue_3964_test PRIVATE
    -O0          # No optimization to match original issue
    -std=c++17   # C++17 standard
    -fopenmp     # Enable OpenMP
    -g           # Debug symbols for crash analysis
)

# Additional linking for math libraries
target_link_libraries(issue_3964_test PRIVATE m)

# Print build information
message(STATUS "Building Issue #3964 reproduction test:")
message(STATUS "- Target: issue_3964_test")
message(STATUS "- Standard: C++17")
message(STATUS "- OpenMP: ${OpenMP_CXX_VERSION}")
message(STATUS "- Optimization: O0 (debug)")
message(STATUS "")
message(STATUS "This test reproduces the exact scenario from:")
message(STATUS "https://github.com/mlpack/mlpack/issues/3964")
message(STATUS "")
message(STATUS "Expected behavior:")
message(STATUS "- x86_64: Should work fine")
message(STATUS "- ARM64 without fix: Segmentation fault")
message(STATUS "- ARM64 with fix: Should work without crash")
